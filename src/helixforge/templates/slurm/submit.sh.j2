#!/bin/bash
# HelixForge SLURM Array Job Submission Script
# Generated by helixforge parallel slurm
#
# This script submits a SLURM array job to process genome chunks in parallel.
# Each array task processes one chunk from the chunk plan JSON file.
#
# Usage:
#   sbatch submit.sh
#
# After completion, run aggregate.sh to combine results.

#SBATCH --job-name={{ job_name }}
#SBATCH --partition={{ partition }}
#SBATCH --time={{ time }}
#SBATCH --mem={{ memory_gb }}G
#SBATCH --cpus-per-task={{ cpus_per_task }}
#SBATCH --array=0-{{ n_chunks - 1 }}{% if max_concurrent %}%{{ max_concurrent }}{% endif %}

#SBATCH --output={{ output_pattern }}
#SBATCH --error={{ error_pattern }}
{% if account %}
#SBATCH --account={{ account }}
{% endif %}
{% if email %}
#SBATCH --mail-user={{ email }}
#SBATCH --mail-type={{ mail_type }}
{% endif %}
{% if qos %}
#SBATCH --qos={{ qos }}
{% endif %}
{% if constraint %}
#SBATCH --constraint={{ constraint }}
{% endif %}
{% if nodes %}
#SBATCH --nodes={{ nodes }}
{% endif %}
{% if ntasks %}
#SBATCH --ntasks={{ ntasks }}
{% endif %}

# ============================================================================
# Environment Setup
# ============================================================================

set -euo pipefail

# Print job info
echo "=========================================="
echo "HelixForge SLURM Array Job"
echo "Job ID: ${SLURM_JOB_ID}"
echo "Array Job ID: ${SLURM_ARRAY_JOB_ID}"
echo "Task ID: ${SLURM_ARRAY_TASK_ID}"
echo "Node: ${SLURM_NODELIST}"
echo "CPUs: ${SLURM_CPUS_PER_TASK}"
echo "Memory: {{ memory_gb }}G"
echo "Start time: $(date)"
echo "=========================================="

# Load modules
{% for module in modules %}
module load {{ module }}
{% endfor %}

# Activate conda environment
{% if conda_env %}
if command -v conda &> /dev/null; then
    source $(conda info --base)/etc/profile.d/conda.sh
    conda activate {{ conda_env }}
fi
{% endif %}

# Additional environment setup
{% if extra_setup %}
{{ extra_setup }}
{% endif %}

# ============================================================================
# Run Task
# ============================================================================

# Execute task script with current array task ID
bash "{{ work_dir }}/task.sh" ${SLURM_ARRAY_TASK_ID}

# ============================================================================
# Completion
# ============================================================================

echo "=========================================="
echo "Task ${SLURM_ARRAY_TASK_ID} completed"
echo "End time: $(date)"
echo "=========================================="
