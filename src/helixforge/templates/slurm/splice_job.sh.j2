#!/bin/bash
# HelixForge Splice Refinement SLURM Job Template
#
# This template generates a complete SLURM array job for splice site refinement.
# Each array task processes one genomic chunk, refining splice sites using
# RNA-seq junction evidence.
#
# Required inputs:
#   - Helixer GFF3 predictions
#   - Genome FASTA file
#   - RNA-seq BAM file (sorted and indexed)
#   - Chunk plan JSON file
#
# Outputs per chunk:
#   - Refined GFF3 file
#   - Splice report TSV
#   - Completion marker (.done file)
#
# Usage:
#   1. Generate with: helixforge parallel slurm --workflow splice ...
#   2. Submit with: sbatch submit.sh
#   3. After completion: bash aggregate.sh

#SBATCH --job-name={{ job_name | default('hf_splice') }}
#SBATCH --partition={{ partition | default('normal') }}
#SBATCH --time={{ time | default('4:00:00') }}
#SBATCH --mem={{ memory_gb | default(16) }}G
#SBATCH --cpus-per-task={{ cpus_per_task | default(1) }}
#SBATCH --array=0-{{ n_chunks - 1 }}{% if max_concurrent %}%{{ max_concurrent }}{% endif %}

#SBATCH --output=logs/%x_%A_%a.out
#SBATCH --error=logs/%x_%A_%a.err
{% if account %}
#SBATCH --account={{ account }}
{% endif %}
{% if email %}
#SBATCH --mail-user={{ email }}
#SBATCH --mail-type={{ mail_type | default('FAIL') }}
{% endif %}

set -euo pipefail

# ============================================================================
# Configuration
# ============================================================================

HELIXER_GFF="{{ helixer_gff }}"
GENOME_FASTA="{{ genome_fasta }}"
RNASEQ_BAM="{{ rnaseq_bam }}"
CHUNK_PLAN="{{ chunk_plan }}"
OUTPUT_DIR="{{ output_dir }}"

# Splice refinement parameters
MAX_SHIFT={{ max_shift | default(15) }}
MIN_READS={{ min_reads | default(3) }}
{% if pwm_file %}
PWM_FILE="{{ pwm_file }}"
{% endif %}

# ============================================================================
# Environment Setup
# ============================================================================

echo "=========================================="
echo "HelixForge Splice Refinement"
echo "Job ID: ${SLURM_JOB_ID}"
echo "Task ID: ${SLURM_ARRAY_TASK_ID}"
echo "Node: ${SLURM_NODELIST}"
echo "Start time: $(date)"
echo "=========================================="

# Load modules
{% for module in modules | default([]) %}
module load {{ module }}
{% endfor %}

{% if conda_env %}
source $(conda info --base)/etc/profile.d/conda.sh
conda activate {{ conda_env }}
{% endif %}

# Create output directory
mkdir -p "${OUTPUT_DIR}"
mkdir -p logs

# ============================================================================
# Extract Chunk Information
# ============================================================================

TASK_ID=${SLURM_ARRAY_TASK_ID}

# Parse chunk plan
CHUNK_JSON=$(python3 -c "
import json
with open('${CHUNK_PLAN}') as f:
    plan = json.load(f)
print(json.dumps(plan['chunks'][${TASK_ID}]))
")

CHUNK_ID=$(echo "$CHUNK_JSON" | python3 -c "import sys, json; print(json.load(sys.stdin)['chunk_id'])")
SEQID=$(echo "$CHUNK_JSON" | python3 -c "import sys, json; print(json.load(sys.stdin)['seqid'])")
START=$(echo "$CHUNK_JSON" | python3 -c "import sys, json; print(json.load(sys.stdin)['start'])")
END=$(echo "$CHUNK_JSON" | python3 -c "import sys, json; print(json.load(sys.stdin)['end'])")

echo "Processing chunk: ${CHUNK_ID}"
echo "  Region: ${SEQID}:${START}-${END}"
echo "  Size: $((END - START)) bp"

# ============================================================================
# Run Splice Refinement
# ============================================================================

echo ""
echo "Running helixforge splice..."

helixforge splice \
    --helixer-gff "${HELIXER_GFF}" \
    --genome "${GENOME_FASTA}" \
    --rnaseq-bam "${RNASEQ_BAM}" \
    --region "${SEQID}:${START}-${END}" \
    --output-gff "${OUTPUT_DIR}/${CHUNK_ID}.gff3" \
    --report "${OUTPUT_DIR}/${CHUNK_ID}_report.tsv" \
    --max-shift ${MAX_SHIFT} \
    --min-reads ${MIN_READS} \
{% if pwm_file %}
    --pwm "${PWM_FILE}" \
{% endif %}
{% if adjust_boundaries %}
    --adjust-boundaries \
{% endif %}
{% if verbose %}
    --verbose \
{% endif %}
    2>&1 | tee "${OUTPUT_DIR}/${CHUNK_ID}.log"

# ============================================================================
# Mark Completion
# ============================================================================

touch "${OUTPUT_DIR}/${CHUNK_ID}.done"

echo ""
echo "=========================================="
echo "Chunk ${CHUNK_ID} complete"
echo "End time: $(date)"
echo "=========================================="
